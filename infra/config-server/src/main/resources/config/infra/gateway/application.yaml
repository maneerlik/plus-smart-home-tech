spring:
  cloud:
    gateway:
      discovery.locator.enabled: true     # Gateway для своей работы должен использовать Discovery Service

    routes:
      - id: shopping_cart_service_route   # Идентификатор роута
        uri: lb://shopping-cart           # Путь, куда роут будет перенаправлять запрос. Префикс lb означает, что Gateway
                                          # с помощью DiscoveryClient и встроенного балансировщика нагрузки найдёт
                                          # экземпляр сервиса с идентификатором shopping-cart. Можно не использовать lb,
                                          # а сразу указать конкретный адрес сервиса н.п.: http://localhost:8081
        predicates:
          - Path=/shopping-cart/**        # Условия, по которым определяется, должен ли роут обрабатывать запрос. Лямбда
                                          # типа 'предикат' (у которой один входной аргумент, а возвращает она true или false)
                                          # https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gateway-request-predicates-factories
        filters:
          - PrefixPath=/api/v1            # Фильтры позволяют модифицировать запрос перед тем, как отправить его по uri.
                                          # Либо модифицировать ответ перед тем, как вернуть его клиенту
                                          # https://cloud.spring.io/spring-cloud-gateway/reference/html/#gatewayfilter-factories

      - id: shopping_store_service_route
        uri: lb://shopping-store          # Роут перехватывает все запросы, начинающиеся с /shopping-store/
        predicates:
          - Path=/shopping-store/**
        filters:
          - PrefixPath=/api/v1            # Добавляет префикс '/api/v1' к пути перед отправкой в shopping-store (н.п. '/shopping-store/products/123' -> '/api/v1/products/123')
          - name: Retry
            args:
              retries: 3                  # Повторяет запрос до 3 раз
              exceptions:
                - ru.yandex.practicum.exception.ProductNotFoundException  # Фильтр срабатывает при перехвате исключения
              methods: GET                # Применяется только к GET-запросам (можно расширить при необходимости)
              backoff:                    # Использует экспоненциальную задержку: 50 мс -> 100 мс -> 200 мс
                firstBackoff: 50ms
                maxBackoff: 200ms
                factor: 2
                basedOnPreviousValue: false # Как рассчитывается задержка (backoff) перед следующей попыткой.
                                            # Задержка вычисляется по формуле: backoff = firstBackoff * (factor ^ n).
                                            #   Попытка 1 -> задержка = 50ms * (2 ^ 0) = 50ms
                                            #   Попытка 2 -> задержка = 50ms * (2 ^ 1) = 100ms
                                            #   Попытка 3 -> задержка = 50ms * (2 ^ 2) = 200ms
      - id: warehouse_service_route
        uri: lb://warehouse
        predicates:
          - Path=/warehouse/**
        filters:
          - PrefixPath=/api/v1

      - id: delivery_service_route
        uri: lb://delivery
        predicates:
          - Path=/delivery/**
        filters:
          - PrefixPath=/api/v1

      - id: payment_service_route
        uri: lb://payment
        predicates:
          - Path=/payment/**
        filters:
          - PrefixPath=/api/v1

      - id: order_service_route
        uri: lb://order
        predicates:
          - Path=/order/**
        filters:
          - PrefixPath=/api/v1

management:
  endpoints:
    web:
      exposure:
        include: "*"      # Включает все эндпоинты Actuator (в т.ч. gateway, health, metrics и т.д.)
  endpoint:
    gateway:
      enabled: true       # Явно включает эндпоинт /actuator/gateway (по умолчанию true, но лучше указать)

server:
  port: 8080              # Конкретный порт (не 0), чтобы пользователи всегда могли обращаться к Gateway
                          # по одному и тому же адресу

logging:
  level:
    org.springframework.orm.jpa: INFO
    org.springframework.transaction: INFO
    org.springframework.transaction.interceptor: TRACE
    org.springframework.orm.jpa.JpaTransactionManager: DEBUG
    org.hibernate.sql: DEBUG
    org.hibernate.type: TRACE
    org.hibernate.orm.jdbc.bind: TRACE